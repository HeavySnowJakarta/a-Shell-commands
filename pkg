#! /bin/sh

# Tool to install/remove commands to a-Shell
#
# options:
# install packageName: pull server/packageName.pkg, execute script packageName.pkg, create .pkg/packageName
# remove packageName: execute .pkg/packageName
# list: show all installed packages
# search + regexp: pull list from server, grep with regexp

# main url. Can be overidden by environment variable
if [ -z "$PKG_SERVER" ]
then
	server=https://raw.githubusercontent.com/holzschu/a-Shell-commands/master/
else
	server=$PKG_SERVER
fi

usage() {
cat << 'EOF'
Usage: pkg [install name] [remove name] [list] [search expression]
  install: installs package "name"
  remove: removes package "name"
  list: list all installed packages
  search: lists packages matching expression

  pkg will search for packages on $PKG_SERVER, if it set, and https://github.com/holzschu/a-Shell-commands otherwise
EOF
}

list() {
	ls -1 ~/Documents/.pkg/
}

search() {
	echo Packages available:
	if [ -z $1 ]
	then
		curl -L $server/list --silent
	else
		expression=$1
		curl -L $server/list --silent | grep $expression
	fi
}

install() {
	for name in $@
	do
		if [ $# -ge 2 ]
		then
			echo Processing $name
		fi
		curl -L $server/list --silent | grep $name > ~/tmp/packageList
		length=`wc -l < ~/tmp/packageList`
		if [ $length -eq 0 ]
		then
			echo Package $name not found
		elif [ $length -eq 1 ]
		then
			packageName=`cat ~/tmp/packageList`
			echo Downloading $packageName
			curl -L $server/packages/$packageName -o ~/tmp/$packageName --silent
			chmod +x ~/tmp/$packageName
			sh ~/tmp/$packageName
			rm ~/tmp/$packageName
			echo Done
		else
			echo Package name $name unclear. Did you mean:
			cat ~/tmp/packageList
		fi
		rm ~/tmp/packageList
	done
}

remove() {
	for name in $@
	do
		if [ $# -ge 2 ]
		then
			echo Processing $name
		fi
		if [ -f ~/Documents/.pkg/$name ]
		then
			echo Removing $name
			sh ~/Documents/.pkg/$name
			rm ~/Documents/.pkg/$name
			mandocdb ~/Library/man
			echo Done
		else
			echo Package $name was not installed by pkg. Cannot remove it.
		fi
	done
}

case $1 in
	# TODO: allow for multiple install (for loop on all arguments except first one)
	install|update|upgrade) 
	    shift
	    install $@
	    ;;
	list) list;;
	remove) 
	    shift
	    remove $@
	    ;;
	search) search $2;;
	*) usage
esac
